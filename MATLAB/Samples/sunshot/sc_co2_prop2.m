function rho = sc_co2_prop2(T,p,rho)

while 1==1
    old_rho = rho;
    rho = func(rho,T,p)
    if abs(old_rho-rho)<0.001
        break;
    end
end

function rho = func(rho,T,p)

Tc = 304.1282; %K
pc = 7.3773; %MPa
rhoc = 467.6; %kg/m3

n = [
    0.38856823203161;
    0.29385475942740E1;
   -0.55867188534934E1;
   -0.76753199592477;
    0.31729005580416;
    0.54803315897767;
    0.12279511220335;
    0.21658961543220E1;
    0.15841735109724E1;
   -0.2313270505503;
    0.58116916431436E-1;
   -0.55369137205382;
    0.48946615909422;
   -0.24275739843501E-1;
    0.62494790501678E-1;
   -0.12175860225246;
   -0.37055685270086;
   -0.16775879700426E-1;
   -0.11960736637987;
   -0.45619362508778E-1;
    0.35612789270346E-1;
   -0.74427727132052E-2;
   -0.17395704902432E-2;
   -0.21810121289527E-1;
    0.24332166559236E-1;
   -0.37440133423463E-1;
    0.14338715756878;
   -0.13491969083286;
   -0.23151225053480E-1;
    0.12363125492901E-1;
    0.21058321972940E-2;
   -0.33958519026368E-3;
    0.55993651771592E-2;
   -0.30335118055646E-3;
   -0.21365488688320E3;
    0.26641569149272E5;
   -0.24027212204557E5;
   -0.28341603423999E3;
    0.21247284400179E3;
   -0.66642276540751;
    0.72608632349897;
    0.55068668612842E-1];

d = [
    1;
    1;
    1;
    1;
    2;
    2;
    3;
    1;
    2;
    4;
    5;
    5;
    5;
    6;
    6;
    6;
    1;
    1;
    4;
    4;
    4;
    7;
    8;
    2;
    3;
    3;
    5;
    5;
    6;
    7;
    8;
    10;
    4;
    8;
    2;
    2;
    2;
    3;
    3];

t = [
    0.00;
    0.75;
    1.00;
    2.00;
    0.75;
    2.00;
    0.75;
    1.50;
    1.50;
    2.50;
    0.00;
    1.50;
    2.00;
    0.00;
    1.00;
    2.00;
    3.00;
    6.00;
    3.00;
    6.00;
    8.00;
    6.00;
    0.00;
    7.00;
   12.00;
   16.00;
   22.00;
   24.00;
   16.00;
   24.00;
    8.00;
    2.00;
   28.00;
   14.00;
    1.00;
    0.00;
    1.00;
    3.00;
    3.00];

c = [
    zeros(7,1);
    1;
    1;
    1;
    1;
    1;
    1;
    1;
    1;
    1;
    2;
    2;
    2;
    2;
    2;
    2;
    2;
    3;
    3;
    3;
    4;
    4;
    4;
    4;
    4;
    4;
    5;
    6];

alpha = [
    zeros(34,1);
    25
    25
    25
    15
    20];

beta = [
    zeros(34,1);
    325
    300
    300
    275
    275
    0.300;
    0.300;
    0.300];

gamma = [
    zeros(34,1);
    1.16;
    1.19;
    1.19;
    1.25;
    1.22];

epsilon = [
    zeros(34,1);
    1.00;
    1.00;
    1.00;
    1.00;
    1.00];

a = [
    zeros(39,1);
    3.500;
    3.500;
    3.000];

b = [
    zeros(39,1);
    0.875;
    0.925;
    0.875];

A = [
    zeros(39,1);
    0.700;
    0.700;
    0.700];
    
B = [
    zeros(39,1);
    0.3;
    0.3;
    1.0];
    
C = [
    zeros(39,1);
    10.0;
    10.0;
    12.5];
    
D = [
    zeros(39,1);
    275;
    275;
    275];

R = 0.1889241;

delta = rho/rhoc;
tau = Tc/T;

phir_d = 0;

for i=1:7
    phir_d = phir_d + n(i)*d(i)*delta^(d(i)-1)*tau^t(i);
end

for i=8:34
    phir_d = phir_d + n(i)*exp(-delta^c(i))*(delta^(d(i)-1)*tau^t(i)*(d(i)-c(i)*delta^c(i)));
end

for i=35:39
    phir_d = phir_d + n(i)*delta^d(i)*tau^t(i)*exp(-alpha(i)*(delta-epsilon(i))^2-beta(i)*(tau-gamma(i))^2)*(d(i)/delta-2*alpha(i)*(delta-epsilon(i)));
end

for i=40:42
    Psi = exp(-C(i)*(delta-1)^2-D(i)*(tau-1)^2);
    theta = (1-tau)+A(i)*((delta-1)^2)^(1/2/beta(i));
    Delta = theta^2+B(i)*((delta-1)^2)^a(i);
    Psi_d = -2*C(i)*(delta-1)*Psi;
    Delta_d = (delta-1)*(A(i)*theta*2/beta(i)*((delta-1)^2)^(1/2/beta(i)-1)+2*B(i)*a(i)*((delta-1)^2)^(a(i)-1));
    Deltabi_d = b(i)*Delta^(b(i)-1)*Delta_d;
    phir_d = phir_d + n(i)*(Delta^b(i)*(Psi+delta*Psi_d)+Deltabi_d*delta*Psi);
end

rho = p/(R*T*(1+phir_d));